name: Test Edge Removal

on:
  workflow_dispatch:

jobs:
  test-edge-removal:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
      - name: Test Edge Removal
        shell: pwsh
        run: |
          Write-Host "Starting Edge removal test..."
          
          # Check initial state
          Write-Host "`nChecking initial Edge state..."
          $edgePaths = @(
              "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe",
              "${env:ProgramFiles(x86)}\Microsoft\Edge\Application\msedge.exe",
              "${env:LOCALAPPDATA}\Microsoft\Edge\Application\msedge.exe"
          )
          
          foreach ($path in $edgePaths) {
              $exists = Test-Path $path
              Write-Host "Edge exists at $path : $exists"
          }
          
          # Stop Edge processes
          Write-Host "`nStopping Edge processes..."
          $processes = "MicrosoftEdgeUpdate", "msedge", "msedgewebview2"
          foreach ($proc in $processes) {
              Get-Process -Name $proc -ErrorAction SilentlyContinue | ForEach-Object {
                  Write-Host "Stopping process: $($_.Name)"
                  Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue
              }
          }
          
          # Remove Edge
          Write-Host "`nRemoving Edge..."
          try {
              # Try to uninstall using CIM
              $installer = Get-CimInstance -ClassName Win32_Product | Where-Object { $_.Name -like "*Microsoft Edge*" }
              if ($installer) {
                  Write-Host "Found Edge installer, attempting to uninstall..."
                  $installer | Invoke-CimMethod -MethodName Uninstall
              }
              
              # Remove Edge folders
              $edgeFolders = @(
                  "C:\Program Files (x86)\Microsoft\Edge",
                  "${env:ProgramFiles(x86)}\Microsoft\Edge",
                  "${env:LOCALAPPDATA}\Microsoft\Edge"
              )
              
              foreach ($folder in $edgeFolders) {
                  if (Test-Path $folder) {
                      Write-Host "Removing folder: $folder"
                      Remove-Item -Path $folder -Recurse -Force -ErrorAction SilentlyContinue
                  }
              }
              
              # Try using standard uninstaller
              $uninstallString = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | Where-Object { $_.DisplayName -like "*Microsoft Edge*" }).UninstallString
              if ($uninstallString) {
                  Write-Host "Found uninstall string: $uninstallString"
                  Start-Process -FilePath $uninstallString -ArgumentList "--uninstall --force-uninstall" -Wait
              }
              
              # Verify removal
              Write-Host "`nVerifying Edge removal..."
              $edgeRemoved = $true
              foreach ($path in $edgePaths) {
                  if (Test-Path $path) {
                      $edgeRemoved = $false
                      Write-Host "Edge still exists at: $path"
                  }
              }
              
              if ($edgeRemoved) {
                  Write-Host "Edge removal successful!"
              } else {
                  throw "Edge files still exist after removal attempt"
              }
              
          } catch {
              Write-Error "Error during Edge removal: $_"
              throw
          }
