name: Test Edge Removal

on:
  workflow_dispatch:

jobs:
  test-edge-removal:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
      - name: Test Edge Removal
        shell: pwsh
        run: |
          # Enable TLS 1.2
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          
          Write-Host "Starting Edge removal test..."
          
          # Check initial state
          Write-Host "`nChecking initial Edge state..."
          $edgeExe = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
          $initialEdgeExists = Test-Path $edgeExe
          Write-Host "Edge executable exists initially: $initialEdgeExists"
          
          $initialPackages = Get-AppxPackage -AllUsers *Microsoft.MicrosoftEdge* | Select-Object -ExpandProperty Name
          Write-Host "Initial Edge packages:"
          if ($initialPackages) {
              $initialPackages | ForEach-Object { Write-Host "  $_" }
          } else {
              Write-Host "  None found"
          }
          
          try {
              # Stop Edge processes
              Write-Host "`nStopping Edge processes..."
              $processes = "MicrosoftEdgeUpdate", "msedge", "msedgewebview2"
              foreach ($proc in $processes) {
                  Get-Process -Name $proc -ErrorAction SilentlyContinue | ForEach-Object {
                      Write-Host "Stopping process: $($_.Name)"
                      Stop-Process -Id $_.Id -Force
                  }
              }
              
              # Remove Edge packages
              Write-Host "`nRemoving Edge packages..."
              Get-AppxPackage -AllUsers *Microsoft.MicrosoftEdge* | ForEach-Object {
                  Write-Host "Removing package: $($_.Name)"
                  Remove-AppxPackage -Package $_.PackageFullName -AllUsers
              }
              
              Get-AppxPackage -AllUsers *Microsoft.MicrosoftEdgeDevToolsClient* | ForEach-Object {
                  Write-Host "Removing DevTools package: $($_.Name)"
                  Remove-AppxPackage -Package $_.PackageFullName -AllUsers
              }
              
              # Verify removal
              Write-Host "`nVerifying Edge removal..."
              $edgeExists = Test-Path $edgeExe
              Write-Host "Edge executable exists: $edgeExists"
              
              $remainingPackages = Get-AppxPackage -AllUsers *Microsoft.MicrosoftEdge* | Select-Object -ExpandProperty Name
              Write-Host "Remaining Edge packages:"
              if ($remainingPackages) {
                  $remainingPackages | ForEach-Object { Write-Host "  $_" }
                  throw "Edge packages still exist after removal attempt"
              } else {
                  Write-Host "  None found - removal successful!"
              }
              
          } catch {
              Write-Error "Error during Edge removal: $_"
              throw
          }
